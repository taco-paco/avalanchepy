from avalanchepy.types.avax.outputs.secp256k1_output_owners import Secp256k1OutputOwners
from avalanchepy.types.avax.outputs.secp256k1_transfer_output import (
    Secp256k1TransferOutput,
)
from avalanchepy.types.avax.outputs.stakeable_lock_out import StakeableLockOut
from avalanchepy.types.avax.outputs.transferable_output import TransferableOutput
from avalanchepy.types.codecs import AVM_CODEC, PVM_CODEC


def test_secp256k1_output_owners():
    data = bytes(
        [
            # type_id:
            0x00,
            0x00,
            0x00,
            0x0B,
            # locktime:
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            # threshold:
            0x00,
            0x00,
            0x00,
            0x01,
            # number of addresses:
            0x00,
            0x00,
            0x00,
            0x01,
            # addrs[0]:
            0xDA,
            0x2B,
            0xEE,
            0x01,
            0xBE,
            0x82,
            0xEC,
            0xC0,
            0x0C,
            0x34,
            0xF3,
            0x61,
            0xED,
            0xA8,
            0xEB,
            0x30,
            0xFB,
            0x5A,
            0x71,
            0x5C,
        ]
    )

    (output, leftover) = AVM_CODEC.unpack_prefix(data)

    assert isinstance(output, Secp256k1OutputOwners)
    assert len(leftover) == 0
    assert AVM_CODEC.pack_prefix(output) == data


def test_secp256k1_transfer_output():
    data = bytes(
        [
            # type_id:
            0x00,
            0x00,
            0x00,
            0x07,
            # amount:
            0x00,
            0x00,
            0x00,
            0x00,
            0xEE,
            0x5B,
            0xE5,
            0xC0,
            # locktime:
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            # threshold:
            0x00,
            0x00,
            0x00,
            0x01,
            # number of addresses:
            0x00,
            0x00,
            0x00,
            0x01,
            # addrs[0]:
            0xDA,
            0x2B,
            0xEE,
            0x01,
            0xBE,
            0x82,
            0xEC,
            0xC0,
            0x0C,
            0x34,
            0xF3,
            0x61,
            0xED,
            0xA8,
            0xEB,
            0x30,
            0xFB,
            0x5A,
            0x71,
            0x5C,
        ]
    )

    (output, leftover) = AVM_CODEC.unpack_prefix(data)

    assert isinstance(output, Secp256k1TransferOutput)
    assert len(leftover) == 0
    assert AVM_CODEC.pack_prefix(output) == data


def test_stakeable_output():
    data = bytes(
        [
            # type_id:
            0x00,
            0x00,
            0x00,
            0x16,
            # locktime:
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0xD4,
            0x31,
            # transferable_out
            0x00,
            0x00,
            0x00,
            0x07,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x30,
            0x39,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0xD4,
            0x31,
            0x00,
            0x00,
            0x00,
            0x01,
            0x00,
            0x00,
            0x00,
            0x02,
            0x51,
            0x02,
            0x5C,
            0x61,
            0xFB,
            0xCF,
            0xC0,
            0x78,
            0xF6,
            0x93,
            0x34,
            0xF8,
            0x34,
            0xBE,
            0x6D,
            0xD2,
            0x6D,
            0x55,
            0xA9,
            0x55,
            0xC3,
            0x34,
            0x41,
            0x28,
            0xE0,
            0x60,
            0x12,
            0x8E,
            0xDE,
            0x35,
            0x23,
            0xA2,
            0x4A,
            0x46,
            0x1C,
            0x89,
            0x43,
            0xAB,
            0x08,
            0x59,
        ]
    )

    (output, leftover) = PVM_CODEC.unpack_prefix(data)

    assert isinstance(output, StakeableLockOut)
    assert len(leftover) == 0
    assert PVM_CODEC.pack_prefix(output) == data


def test_transferable_output():
    data = bytes(
        [
            0x68,
            0x70,
            0xB7,
            0xD6,
            0x6A,
            0xC3,
            0x25,
            0x40,
            0x31,
            0x13,
            0x79,
            0xE5,
            0xB5,
            0xDB,
            0xAD,
            0x28,
            0xEC,
            0x7E,
            0xB8,
            0xDD,
            0xBF,
            0xC8,
            0xF4,
            0xD6,
            0x72,
            0x99,
            0xEB,
            0xB4,
            0x84,
            0x75,
            0x90,
            0x7A,
            0x00,
            0x00,
            0x00,
            0x07,
            0x00,
            0x00,
            0x00,
            0x00,
            0xEE,
            0x5B,
            0xE5,
            0xC0,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x01,
            0x00,
            0x00,
            0x00,
            0x01,
            0xDA,
            0x2B,
            0xEE,
            0x01,
            0xBE,
            0x82,
            0xEC,
            0xC0,
            0x0C,
            0x34,
            0xF3,
            0x61,
            0xED,
            0xA8,
            0xEB,
            0x30,
            0xFB,
            0x5A,
            0x71,
            0x5C,
        ]
    )  # noqa: E501

    (transferable_output, leftover) = TransferableOutput.deserialize(data, PVM_CODEC)

    assert len(leftover) == 0
    assert transferable_output.serialize(PVM_CODEC) == data


def test_transferable_output_2():
    data = bytes(
        [
            219,
            207,
            137,
            15,
            119,
            244,
            155,
            150,
            133,
            118,
            72,
            183,
            43,
            119,
            249,
            248,
            41,
            55,
            242,
            138,
            104,
            112,
            74,
            240,
            93,
            160,
            220,
            18,
            186,
            83,
            242,
            219,
            0,
            0,
            0,
            7,
            0,
            0,
            0,
            0,
            0,
            30,
            132,
            128,
            0,
            0,
            0,
            0,
            0,
            30,
            132,
            128,
            0,
            0,
            0,
            13,
            0,
            0,
            0,
            2,
            141,
            185,
            124,
            124,
            236,
            226,
            73,
            194,
            185,
            139,
            220,
            2,
            38,
            204,
            76,
            42,
            87,
            191,
            82,
            252,
            141,
            185,
            124,
            124,
            236,
            226,
            73,
            194,
            185,
            139,
            220,
            2,
            38,
            204,
            76,
            42,
            87,
            191,
            82,
            252,
        ]
    )

    (transferable_output, leftover) = TransferableOutput.deserialize(data, PVM_CODEC)

    assert len(leftover) == 0
    assert transferable_output.serialize(PVM_CODEC) == data
